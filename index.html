<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <title>Daily Glucose Levels vs. Diabetes Status</title>
        <style>
            html,
            body {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                font-family: sans-serif;
            }
            #controls {
                position: absolute;
                top: 120px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10;
                background: rgba(255, 255, 255, 0.8);
                padding: 10px;
                border-radius: 8px;
            }
            svg {
                display: block;
                margin: auto;
                max-width: 100%;
                height: auto;
            }
        </style>
    </head>

    <body>
        <div id="controls">
            <label for="daySlider">
                Select Day:
                <span id="dayValue">1</span>
            </label>
            <input
                type="range"
                id="daySlider"
                min="1"
                max="10"
                step="1"
                value="1"
            />
        </div>

        <script>
            const margin = [120, 100, 100, 180];
            let width = window.innerWidth,
                height = window.innerHeight;

            let svg, tooltip, simulation, circles;
            let currentDay = 1;
            let globalData = [];

            const diabetesCategories = [
                "Non-Diabetic",
                "Pre-Diabetic",
                "Type 2 Diabetic",
            ];
            const gutColors = {
                1: "#a8c8ea",
                2: "#4f93d2",
                3: "#084594",
            };

            let yScale;

            function initChart(data) {
                d3.select("svg").remove();

                width = window.innerWidth;
                height = window.innerHeight;

                svg = d3
                    .select("body")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", `0 0 ${width} ${height}`) // ✅ Ensures consistency
                    .attr("preserveAspectRatio", "xMidYMid meet"); // ✅ Keeps aspect ratio stable

                tooltip = d3
                    .select("body")
                    .append("div")
                    .style("position", "absolute")
                    .style("visibility", "hidden")
                    .style("background", "#fff")
                    .style("padding", "8px")
                    .style("border", "1px solid #000")
                    .style("border-radius", "5px")
                    .style("box-shadow", "2px 2px 10px rgba(0,0,0,0.5)")
                    .style("pointer-events", "none");

                // TITLE
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", margin[0] / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "28px")
                    .style("font-weight", "bold")
                    .text("Daily Glucose Levels Across Diabetes Status");

                // SUBTITLE
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", margin[0] / 2 + 30)
                    .attr("text-anchor", "middle")
                    .style("font-size", "20px")
                    .style("fill", "#555")
                    .text(
                        "Each circle represents an individual. Position = Daily Glucose (mg/dL), Size = BMI, Color = Gut Health (1-3)"
                    );

                let allDays = [];
                for (let i = 1; i <= 10; i++) {
                    const col = "day" + i;
                    data.forEach((d) => allDays.push(d[col]));
                }
                let maxDayVal = d3.max(allDays) || 100;

                let xScale = d3
                    .scaleBand()
                    .domain(diabetesCategories)
                    .range([margin[3], width - margin[1]])
                    .padding(0.5);

                yScale = d3
                    .scaleLinear()
                    .domain([0, maxDayVal])
                    .range([height - margin[2], margin[0]]);

                let bmiExtent = d3.extent(data, (d) => d.bmi);
                let sizeScale = d3
                    .scaleLinear()
                    .domain(bmiExtent)
                    .range([8, 40])
                    .clamp(true);

                // X Axis
                svg.append("g")
                    .attr("transform", `translate(0, ${height - margin[2]})`)
                    .call(d3.axisBottom(xScale))
                    .selectAll("text")
                    .style("text-anchor", "middle")
                    .style("font-size", "16px");

                // Y Axis
                svg.append("g")
                    .attr("transform", `translate(${margin[3]},0)`)
                    .call(d3.axisLeft(yScale))
                    .selectAll("text")
                    .style("font-size", "16px");

                simulation = d3
                    .forceSimulation(data)
                    .force(
                        "x",
                        d3
                            .forceX(
                                (d) =>
                                    xScale(d.diabetes_status) +
                                    xScale.bandwidth() / 2
                            )
                            .strength(0.2)
                    )
                    .force(
                        "y",
                        d3
                            .forceY((d) => yScale(d["day" + currentDay] || 0))
                            .strength(0.4)
                    )
                    .force(
                        "collide",
                        d3.forceCollide((d) =>
                            d.bmi > 0 ? sizeScale(d.bmi) : 3
                        )
                    )
                    .alphaDecay(0)
                    .alpha(0.3)
                    .on("tick", ticked);

                circles = svg
                    .selectAll(".circ")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("stroke", "black")
                    .attr(
                        "fill",
                        (d) => gutColors[d.gut_microbiome_health] || "#999"
                    )
                    .attr("r", (d) => (d.bmi > 0 ? sizeScale(d.bmi) : 3))
                    .style("opacity", 0.7);
            }

            function ticked() {
                circles.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
            }

            function updateDay(day) {
                currentDay = day;
                if (!simulation) return;
                simulation.force(
                    "y",
                    d3.forceY((d) => yScale(d["day" + day] || 0)).strength(0.4)
                );
                simulation.alpha(0.5).restart();
            }

            d3.csv("data.csv").then((data) => {
                data.forEach((d) => {
                    for (let i = 1; i <= 10; i++)
                        d["day" + i] = +d["day" + i] || 0;
                    d.bmi = +d.bmi || 0;
                    d.gut_microbiome_health = +d.gut_microbiome_health || 1;
                });
                globalData = data;
                initChart(data);
            });

            document
                .getElementById("daySlider")
                .addEventListener("input", function () {
                    document.getElementById("dayValue").textContent =
                        this.value;
                    updateDay(+this.value);
                });

            window.addEventListener("resize", () => {
                if (globalData.length) initChart(globalData);
                updateDay(currentDay);
            });
        </script>
    </body>
</html>
